# ModelHub: A Framework for Evaluating Large Language Models on Visual-Reasoning Tasks

This repository, **ModelHub**, provides a comprehensive framework for generating synthetic scenes, simulating agent trajectories, and evaluating the performance of large language models (LLMs) on a variety of visual-reasoning tasks. It leverages Blender for scene rendering and provides tools for automated question generation and answering.

## Key Features

- **Synthetic Scene Generation:** Create diverse scenes with objects of various shapes, colors, sizes, and textures. Control object placement, camera height, and agent trajectories.
- **Trajectory Simulation:** Generate agent trajectories with customizable parameters like trajectory size and turning probability. Simulate agent movement within the generated scenes using Blender.
- **Automated Question Generation:** Generate a wide range of questions related to the simulated scenes, including:
  - **Number questions:** "How many red cubes are there?"
  - **Comparison questions:** "Are there more red objects or blue objects?"
  - **Existence questions:** "Was there a green sphere?"
  - **Order-preserving questions:** "Did we see a red cube before or after a blue sphere?"
  - **Directional questions:** "Is the red cube to the left of the blue sphere?"
- **LLM Evaluation:** Evaluate the performance of various LLMs (e.g., GPT-4o, Gemini, Claude) on the generated questions using the provided API wrappers.
- **Reproducibility:**  Control randomness using a seed for reproducible scene generation and agent trajectories.
- **Visualization:** Generate plots of the scene layout and agent trajectory for easy inspection.
- **Dataset Generation:** Generate datasets of scenes and question-answer pairs to train and evaluate visual-reasoning models.

## Repository Structure

The repository is organized into the following directories and files:

- **`/src`**: Contains the main source code for the project.
  - **`generate_scene.py`**:  Handles scene generation, trajectory creation, and configuration saving.
  - **`generate_dataset.py`**: Generates a dataset of scenes with varying parameters.
  - **`run_simulation.py`**: Runs the Blender simulation to capture images and annotations along the trajectory.
  - **`run_all_trajectories.py`**: Batch runs simulations over multiple trajectory directories.
  - **`api_models.py`**: Contains wrappers for interacting with various LLMs (GPT, Gemini, Claude, and Ollama models).
  - **`process_images.py`**: Processes images with an LLM to answer questions about the scene and extract ground truth information.
  - **`overseer.py`**: Orchestrates the entire process of running simulations and generating question-answer pairs for multiple trajectories.
  - **`trajectories/`**:  Contains subdirectories for each trajectory, each with a `scene_config.json` and a `trajectory_moves.txt` file.
    - **`{run_number}-{run_name}/`**:
      - **`scene_config.json`**: Configuration file for the scene.
      - **`trajectory_moves.txt`**: Contains the sequence of moves for the agent's trajectory.
      - **`images/`**: Output directory for images and annotations generated by `run_simulation.py`.
        - **`annotations.csv`**: Contains image filenames, annotations, and visible objects for each frame.
  - **`question_answering/`**: Contains scripts for generating different types of questions.
    - **`common_utils.py`**: Common utility functions used by the question generation scripts.
    - **`generate_comparison_in_frame_questions.py`**: Generates comparison questions that can be answered from a single frame.
    - **`generate_comparison_out_of_frame_questions.py`**: Generates comparison questions that require information from multiple frames.
    - **`generate_directional_questions.py`**: Generates questions about the relative left-right positions of objects.
    - **`generate_number_questions.py`**: Generates questions about the number of objects of a certain type.
    - **`generate_order_preserving_questions.py`**: Generates questions about the order in which objects were seen.
  - **`questions.txt`**: An example file with questions to be answered by the LLM.
- **`/`**
  - **`README.md`**: This file.

## Setup and Installation

1. **Prerequisites:**
    - Python 3.9+
    - Blender 4.2+ (Make sure Blender is added to your system PATH, or update the `BLENDER_EXE` variable in `run_all_trajectories.py`.)
    - Ollama (if using LLaVa models)

2. **Clone the repository:**

    ```bash
    git clone <repository_url>
    cd modelhub
    ```

3. **Install dependencies:**

    ```bash
    pip install -r requirements.txt
    ```

## Usage

### 1. Generate Scenes and Trajectories

The `generate_scene.py` script is used to create scene configurations and agent trajectories.

**Basic Usage:**

```bash
python src/generate_scene.py --num-shapes 24 --trajectory-size 8 --seed 42 --same-size --homogenous-texture
```

**Arguments:**

- `--num-shapes`: Total number of shapes to generate in the scene (minimum 8, default: 24).
- `--times`: Number of duplicates for each selected object. Each value `t` means the object appears `t+1` times (e.g., `[0, 1]` means one object appears once, and another appears twice).
- `--camera-height`: Specify the camera height in meters (default: None).
- `--trajectory-size`: Number of moves in the agent's trajectory (default: 8, allowed: 1, 2, 4, 8, 16, 32, 64).
- `--turn-prob`: Probability of turning at each step (default: 0.3).
- `--seed`: Random seed for reproducibility (default: None).
- `--same-size`: If set, all generated shapes are only large (1m).
- `--homogenous-texture`: If set, all objects have rubber texture, and texture is omitted from names.

**Output:**

The script generates a new directory under `src/trajectories/` with a name like `0001-run/`. This directory will contain:

- `scene_config.json`: A JSON file describing the scene configuration, including object types, positions, colors, sizes, textures, camera height, and trajectory.
- `trajectory_moves.txt`: A text file listing the sequence of moves (e.g., "straight", "turn left 15 degrees") for the agent's trajectory.
- `scene_plot.png`: A visualization of the scene layout and agent trajectory.

**Example:**

```bash
python src/generate_scene.py --num-shapes 16 --trajectory-size 4 --times 0 0 --seed 123
```

This will generate a scene with 16 shapes, a trajectory of 4 moves, two objects duplicated once (each appearing twice), using a random seed of 123.

### 2. Generate a Dataset of Scenes

The `generate_dataset.py` script generates a dataset of scenes with varying parameters, which is useful for creating diverse training or evaluation data.

**Basic Usage:**

```bash
python src/generate_dataset.py
```

**Configuration:**

- `TRAJECTORY_SIZES`: A list of trajectory sizes to use (default: `[2, 4, 8, 16, 32, 64]`).
- `NUM_SHAPES_LIST`: A list of the number of shapes to generate in each scene (default: `[8, 16, 24]`).
- `NUM_EXAMPLES`: The number of examples to generate for each combination of parameters (default: 5).
- `MAX_RETRIES`: The maximum number of retries for generating a scene (default: 3).
- `RETRY_DELAY`: The delay in seconds between retries (default: 2).
- `ALLOWED_TIMES_SETS`: A list of allowed `times` parameter sets for object duplication (see `generate_scene.py`).

**Output:**

The script will generate multiple trajectory directories under `src/trajectories/`, each with a unique combination of parameters.

### 3. Run Blender Simulation

The `run_simulation.py` script uses Blender to render the scene and simulate the agent's trajectory, capturing images and annotations at each step.

**Basic Usage:**

```bash
blender --background --python src/run_simulation.py -- --config-file src/trajectories/0001-run/
```

**Arguments (passed after `--`):**

- `--config-file`: Path to the directory containing the `scene_config.json` file (e.g., `src/trajectories/0001-run/`).
- `--draft`: Use draft mode for faster rendering with lower quality (default: False).
- `--no-description`: Exclude description from annotations (default: False).
- `--no-position`: Exclude position from annotations (default: False).
- `--debug`: Enable debug mode (default: False).

**Output:**

The script will create an `images/` directory within the trajectory directory (e.g., `src/trajectories/0001-run/images/`) containing:

- `image_0000_init.png`, `image_0001_move_forward_1m.png`, etc.: Captured images along the trajectory.
- `annotations.csv`: A CSV file with the following columns:
  - `image_filename`: The name of the image file.
  - `annotation`: An optional annotation string (e.g., "This image was taken after moving forward by 1 meter.").
  - `visible_objects`: A comma-separated list of visible objects in the image, along with their pixel percentages (e.g., "green_cuboid_3 (0.20%), black_sphere_18 (0.58%)").

### 4. Batch Run Simulations

The `run_all_trajectories.py` script automates the process of running simulations for multiple trajectory directories.

**Basic Usage:**

```bash
python src/run_all_trajectories.py
```

**Configuration:**

- `TRAJECTORY_DIR`: Path to the directory containing trajectory subdirectories (default: `./src/trajectories`).
- `BLENDER_EXE`: Path to the Blender executable (you may need to adjust this based on your system).
- `PYTHON_SCRIPT`: Path to the `blender_run_simulation.py` script (default: `./src/blender_run_simulation.py`).

**Output:**

The script will run the Blender simulation for each subdirectory within `TRAJECTORY_DIR`, generating images and annotations for each trajectory.

### 5. Generate Questions

The scripts in the `src/question_answering/` directory generate different types of questions about the simulated scenes.

- **`generate_number_questions.py`**: Generates questions about the number of objects of a certain type (e.g., "How many red objects are there?", "How many spheres are there?").
- **`generate_comparison_questions.py`**: Generates questions comparing the number of objects of different types (e.g., "Are there more red objects or blue objects?"). It generates questions that can be answered either from a single frame (`generate_comparison_in_frame_questions.py`) or requires comparing multiple frames (`generate_comparison_out_of_frame_questions.py`).
- **`generate_order_preserving_questions.py`**: Generates questions about the order in which objects were first seen (e.g., "Did we see a red cube before or after a blue sphere?").
- **`generate_directional_questions.py`**: Generates questions about the left-right relationships between objects (e.g., "Is the red cube to the left of the blue sphere?").

**Basic Usage (Example for number questions):**

```bash
python src/question_answering/generate_number_questions.py
```

**Output:**

Each script will generate a CSV file (e.g., `number_questions.csv`) in the same directory as the `annotations.csv` file, containing the generated questions and their corresponding answers.

### 6. Process Images with an LLM

The `process_images.py` script uses an LLM to answer questions about the generated scenes and images.

**Basic Usage:**

```bash
python src/process_images.py <trajectory_dir> --mode <all_at_once|sequential> --questions_file <questions_file> --model <model_name> --answers_dir <answers_dir>
```

**Arguments:**

- `trajectory_dir`: Path to the trajectory directory (e.g., `src/trajectories/0001-run/`).
- `--mode`: Processing mode:
  - `all_at_once`: Sends all images to the LLM in a single API call.
  - `sequential`: Processes images one by one, sending each image to the LLM separately.
- `--questions_file`: Path to a text file containing questions, one per line. If not provided, the script will prompt the user to enter a question.
- `--model`: The model to use for processing. Supported models are listed in `api_models.py`.
- `--answers_dir`: Directory where the answers will be saved. If not specified, it defaults to `trajectory_dir/answers`.

**Output:**

- `llm_answer.txt`: A text file containing the LLM's answer to the question.
- `ground_truth_all.txt`: A text file containing all visible instances in the scene.
- `ground_truth_valid.txt`: A text file containing visible instances with over 100px visible.
- `robot_vision_state.json`: A JSON file storing the state of the `RobotVision` instance, including processed images, annotations, and the current answer.

**Example:**

```bash
python src/process_images.py src/trajectories/0001-run --mode all_at_once --questions_file src/questions.txt --model gemini-1.5-pro-002
```

### 7. Overseer: Automating Simulations and Question Answering

The `overseer.py` script automates the entire process of running simulations and generating question-answer pairs for multiple trajectories.

**Basic Usage:**

```bash
python src/overseer.py --trajectories_dir <trajectories_dir> --num_questions <num_questions> --model <model_name>
```

**Arguments:**

- `--trajectories_dir`: Path to the directory containing trajectory subdirectories (default: `./src/trajectories`).
- `--num_questions`: Number of questions to generate per trajectory per question type (default: 5).
- `--model`: Model to use for processing (default: `gemini-1.5-pro-002`).

**Output:**

The script will:

1. Run the simulation for each trajectory directory.
2. Generate questions for each trajectory using the scripts in `src/question_answering/`.
3. Process the images and questions with the specified LLM using `automate_question_answering.py`
4. Save the results (images, annotations, questions, answers, and LLM responses) in each trajectory directory.

## Extending and Customizing

- **Adding New LLMs:** You can add support for new LLMs by creating a new class that inherits from the `Model` class in `api_models.py` and implementing the `call_model` and `count_tokens` methods.
- **Adding New Question Types:** You can create new question types by adding new scripts to the `src/question_answering/` directory. Each script should generate a CSV file with "question" and "answer" columns.
- **Customizing the System Prompt:** You can modify the `system_prompt` in `process_images.py` to tailor the LLM's behavior and instructions.
- **Adding More Complex Trajectories:** You can create more complex agent trajectories by modifying the `generate_trajectory` function in `generate_scene.py`.

## Troubleshooting

- **Blender Errors:** If you encounter errors related to Blender, make sure that Blender is properly installed and that the `BLENDER_EXE` variable in `run_all_trajectories.py` is set correctly.
- **API Key Errors:** If you get errors related to API keys, ensure that you have set the correct API keys for the LLMs you are using in `api_models.py`.
- **Ollama Errors:** If you are using Ollama models and encounter errors make sure that the Ollama application is open and the models are downloaded.

## Contributing

Contributions to this project are welcome! Please feel free to open issues or submit pull requests.

## License

This project is licensed under the MIT License - see the `LICENSE` file for details.
